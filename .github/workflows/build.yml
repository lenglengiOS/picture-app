# .github/workflows/build-release.yml
name: Build Electron App

# 触发条件：推送到 main 分支时运行
on:
  push:
    branches: [main]
  # 可选：允许在 GitHub Actions 页面手动触发此工作流
  workflow_dispatch:

jobs:
  build:
    # 使用矩阵策略，定义三个构建环境并行执行
    strategy:
      matrix:
        # 分别构建 macOS Intel、macOS ARM、Windows x64
        os: [macos-12, macos-14, windows-latest]
        # 根据操作系统定义目标平台和架构
        include:
          - os: macos-12
            platform: mac
            args: --x64
          - os: macos-14
            platform: mac
            args: --arm64
          - os: windows-latest
            platform: win
            args: --x64
    # 在对应的操作系统上运行
    runs-on: ${{ matrix.os }}
    name: Build for ${{ matrix.platform }} (${{ matrix.args }})

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. 设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22" # 使用与项目兼容的 Node 版本

      # 3. 安装依赖（macOS可能需要处理特定依赖）
      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      # 4. 执行构建命令
      - name: Build Electron App
        run: npm run dist -- --publish=never
        env:
          # 传递给 electron-builder 的参数，指定目标平台和架构
          ELECTRON_BUILDER_ARGS: ${{ matrix.args }}

      # 5. 上传构建产物（安装包）
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.args }}-installer
          path: |
            dist/*.dmg
            dist/*.exe
            dist/*.msi
          # 设置较长的保留时间，便于下载
          retention-days: 7
