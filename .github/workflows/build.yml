name: Build Electron App

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-14
            platform: mac
            args: --x64
          - os: macos-14
            platform: mac
            args: --arm64
          - os: windows-latest
            platform: win
            args: --x64
    runs-on: ${{ matrix.os }}
    name: Build for ${{ matrix.platform }} (${{ matrix.args }})

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22

      # 第一步：安装除sharp外的基础依赖
      - name: Install Dependencies (Excluding Sharp)
        run: npm ci --omit=optional --legacy-peer-deps

      # 第二步：为目标平台安装正确的sharp二进制文件
      - name: Install Sharp for Target Platform
        run: |
          npm uninstall sharp --legacy-peer-deps || true
          if [ "${{ matrix.platform }}" == "mac" ] && [ "${{ matrix.args }}" == "--x64" ]; then
            npm install --save --cpu=x64 --platform=darwin --libc=glibc sharp@0.34.5 --legacy-peer-deps
          elif [ "${{ matrix.platform }}" == "mac" ] && [ "${{ matrix.args }}" == "--arm64" ]; then
            npm install --save --cpu=arm64 --platform=darwin sharp@0.34.5 --legacy-peer-deps
          elif [ "${{ matrix.platform }}" == "win" ]; then
            npm install --save --cpu=x64 --platform=win32 sharp@0.34.5 --legacy-peer-deps
          fi

      # 第三步：进行打包构建
      - name: Build Electron App
        run: |
          npm run build:renderer
          npx electron-builder ${{ matrix.args }} --publish=never

      # 5.  上传构建产物
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.args }}-installer
          path: |
            dist/*.dmg
            dist/*.exe
            dist/*.msi
          retention-days: 7

      # 6. 发布到 Release（使用 GH_TOKEN）
      - name: Publish Release Assets
        run: npx electron-builder ${{ matrix.args }} --publish=always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
